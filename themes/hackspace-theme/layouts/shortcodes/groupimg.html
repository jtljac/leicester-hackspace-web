{{/*
    This shortcode is initially inspired by 
    https://www.brycewray.com/posts/2022/06/responsive-optimized-images-hugo/
    Adjustments have been made.
*/}}
{{/* - variables - */}}
{{- $imgClass := "animate-fade" -}}
{{- $ignore := or (.Get "ignore") slice "" -}}
{{- $include := or (.Get "include") slice "" -}}
{{- $widthParam := or (.Get "width") 730 -}}
{{/* ---------------- */}}
<div class="img-group">
{{- range .Page.Resources.ByType "image" -}}
{{- if not (collections.In $ignore .Name) -}}
{{- $width := cast.ToString (math.Min $widthParam .Width) -}}
{{/*
	Create a 640-pixel-wide JPG of the image that will serve 
    as the "fallback" image for that tiny percentage of browsers 
    that don't understand the HTML `picture` tag.
*/}}
{{- $fallbackImg := .Resize "640x jpg" -}}
{{/*
    LQIP = Low Quality Image Placeholder
	Create a 20-pixel-wide LQIP and turn it into Base64-encoded data, 
    which is better for performance and caching.
*/}}
{{- $LQIP_img := .Resize "20x jpg" -}}
{{- $LQIP_b64 := $LQIP_img.Content | base64Encode -}}
{{- $LQIP_css := printf "%s%s%s" "background: url(data:image/jpeg;base64," $LQIP_b64 "); background-repeat: no-repeat; width: fit-content; height: fit-content; " -}}
<div class="bg-center img-container" style="{{ $LQIP_css | safeCSS }}">
    <picture>
        <source
            type="image/webp"
            srcset="{{ (.Resize (printf "%sx%s" $width " webp")).RelPermalink }}"
        />
        <source
            type="image/jpeg"
            srcset="{{ (.Resize (printf "%sx%s" $width " jpeg")).RelPermalink }}"
        />
        <img class="{{ $imgClass }}"
            style="max-width: {{ $width }}px"
            src="{{ $fallbackImg.RelPermalink }}"
            loading="lazy"
        />
    </picture>
</div>
{{- end -}}
{{- end -}}
</div>